<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PDF RAG MVP</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>PDF RAG MVP</h1>
    <div class="controls">
      <button id="ingest">Build Index</button>
      <input id="q" type="text" placeholder="Ask something…" />
      <select id="mode">
        <option value="matches">Closest matches</option>
        <option value="rag">Light RAG</option>
      </select>
      <button id="ask">Search</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Answer</h2>
        <pre id="answer"></pre>
      </div>
      <div class="panel">
        <h2>Evidence</h2>
        <div id="results"></div>
      </div>
      <div class="panel">
        <h2>PDF</h2>
        <iframe id="pdf" src="/static/doc.pdf#page=1" title="PDF" width="100%" height="600"></iframe>
      </div>
    </div>
  </div>

  <script>
    const ingestBtn = document.getElementById('ingest');
    const askBtn = document.getElementById('ask');
    const q = document.getElementById('q');
    const mode = document.getElementById('mode');
    const answer = document.getElementById('answer');
    const results = document.getElementById('results');
    const pdf = document.getElementById('pdf');

    ingestBtn.onclick = async () => {
      ingestBtn.disabled = true;
      const res = await fetch('/ingest', {method: 'POST'});
      const j = await res.json();
      alert(j.status ? 'Index ready.' : 'Ingest failed.');
      ingestBtn.disabled = false;
    };

    askBtn.onclick = async () => {
      results.innerHTML = '';
      answer.textContent = 'Thinking…';
      const m = mode.value;
      const endpoint = m === 'matches' ? '/answer?mode=matches' : '/answer?mode=rag';
      const res = await fetch(endpoint + '&query=' + encodeURIComponent(q.value));
      const j = await res.json();
      answer.textContent = j.answer || '';
      (j.hits || []).forEach(h => {
        const div = document.createElement('div');
        div.className = 'hit';
        const a = document.createElement('a');
        a.href = h.citation_url;
        a.target = 'pdf';
        a.textContent = `p.${h.page}`;
        a.onclick = () => { pdf.src = h.citation_url; };
        div.innerHTML = `
          <div><b>${h.kind}</b> – score ${h.score.toFixed(3)}</div>
          <div>Page: </div>
        `;
        div.children[1].appendChild(a);
        results.appendChild(div);
      });
      // auto-focus PDF on first hit
      if (j.hits && j.hits[0]) pdf.src = j.hits[0].citation_url;
    };
  </script>
</body>
</html>
